{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "Base URL for Template Files",
                "artifactsBaseUrl": ""
            },
            "defaultValue": "https://raw.githubusercontent.com/SpektraSystems/openshift-container-platform/master"
        },

        "adminUsername": {
            "type": "string",
            "defaultValue": "ocpadmin",
            "minLength": 1,
            "metadata": {
                "description": "Administrator username on all VMs and first user created for OpenShift login"
            }
        },
        "openshiftPassword": {
            "type": "securestring",
            "minLength": 1,
            "metadata": {
                "description": "Password for OpenShift user to login to OpenShift Console"
            }
        },

        "rhsmUsernamePasswordOrActivationKey": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "usernamepassword",
            "allowedValues": [
                "usernamepassword", "activationkey"
            ],
            "metadata": {
                "description": "Select whether you want to use your Red Hat Subscription Manager Username and Password or Organization ID and Activation Key to register the RHEL instance to your Red Hat Subscription."
            }
        },
        "rhsmUsernameOrOrgId": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Red Hat Subscription Manager Username or Organization ID. If usernamepassword selected in previous input, then use Username; otherwise entier Organization ID. To find your Organization ID, run on registered server: subscription-manager identity"
            }
        },
        "rhsmPasswordOrActivationKey": {
            "type": "securestring",
            "minLength": 1,
            "metadata": {
                "description": "Red Hat Subscription Manager Password or Activation Key. To find or create your Activation Key, go to: https://access.redhat.com/management/activation_keys"
            }
        },
        "rhsmPoolId": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Red Hat Subscription Manager Pool ID with OpenShift entitlements. To find it, run on registered server: subscription-manager list"
            }
        },
        "sshPublicKey": {
            "type": "string",
            "metadata": {
                "description": "SSH public key for all VMs"
            }
        },

        "keyVaultName": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Name of the Key Vault"
            }
        },
        "keyVaultSecret": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Key Vault Secret Name that contains the Private Key"
            }
        },
        "azureIntegrationClientId": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Azure Integration Client ID"
            }
        },
        "azureIntegrationClientSecret": {
            "type": "securestring",
            "minLength": 1,
            "metadata": {
                "description": "Azure Integration Client Secret"
            }
        },
        "aadAuthAppName": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Azure AD App Name used for Authentication"
            }
        },

        "aadAuthClientId": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Azure AD Authentication Client ID"
            }
        },
        "aadAuthClientSecret": {
            "type": "securestring",
            "minLength": 1,
            "metadata": {
                "description": "Azure AD Authentication Client Secret"
            }
        }
    },
    "variables": {
        "masterInstanceCount": 3,
        "infraInstanceCount": 2,
        "nodeInstanceCount": 1,
        "dataDiskSize": 128,

        "enableMetrics": "true",
        "enableLogging": "true",
        "enableCockpit": "true",

        "enableAzure": "true",
        "aadClientId": "[parameters('azureIntegrationClientId')]",
        "aadClientSecret": "[parameters('azureIntegrationClientSecret')]",
        "masterVmSize": "Standard_DS2_v2",
        "infraVmSize": "Standard_DS11_v2",
        "nodeVmSize": "Standard_DS2_v2",
        "location": "[resourceGroup().location]",
        "defaultSubDomainType": "nipio",
        "resourceGroupName": "[resourceGroup().id]",
        "apiVersionCompute": "2017-03-30",
        "apiVersionNetwork": "2017-09-01",
        "apiVersionStorage": "2017-06-01",
        "apiVersionLinkTemplate": "2015-01-01",
        "defaultSubDomain": "contoso.com",
        "namingInfix": "oscluster",
        "openshiftBastionHostname": "[concat(variables('namingInfix'), '-bastion')]",
        "openshiftMasterHostname": "[concat(variables('namingInfix'), '-master')]",
        "openshiftNodeHostname": "[concat(variables('namingInfix'), '-node')]",
        "openshiftInfraHostname": "[concat(variables('namingInfix'), '-infra')]",
        "newStorageAccountBastion": "[concat('bastion', uniqueString(concat(resourceGroup().id, 'bsa')))]",
        "newStorageAccountMaster": "[concat('master', uniqueString(concat(resourceGroup().id, 'msa')))]",
        "newStorageAccountInfra": "[concat('infra', uniqueString(concat(resourceGroup().id, 'isa')))]",
        "newStorageAccountNodeOs": "[concat('nodeos', uniqueString(concat(resourceGroup().id, 'nodeossa')))]",
        "newStorageAccountNodeData": "[concat('nodedata', uniqueString(concat(resourceGroup().id, 'nodedatasa')))]",
        "diagStorageAccount1": "[concat('diag1', uniqueString(concat(resourceGroup().id, 'dsa1')))]",
        "diagStorageAccount2": "[concat('diag2', uniqueString(concat(resourceGroup().id, 'dsa2')))]",
        "newStorageAccountRegistry": "[concat('registry', uniqueString(concat(resourceGroup().id, 'registry')))]",
        "newStorageAccountPersistentVolume1": "[concat('pv1sa', uniqueString(concat(resourceGroup().id, 'persistentvolume1')))]",
        "addressPrefix": "10.0.0.0/8",
        "masterSubnetPrefix": "10.1.0.0/16",
        "nodeSubnetPrefix": "10.2.0.0/16",
        "virtualNetworkName": "openshiftvnet",
        "masterSubnetName": "mastersubnet",
        "nodeSubnetName": "nodesubnet",
        "bastionPublicIp": "bastionpublicip",
        "bastionPublicIpDnsLabel": "[concat('bastiondns', uniqueString(resourceGroup().id))]",
        "infraLbPublicIpDnsLabel": "[concat('infradns', uniqueString(concat(resourceGroup().id, 'infra')))]",
        "openshiftMasterPublicIpDnsLabel": "[concat('masterdns', uniqueString(concat(resourceGroup().id, 'master')))]",
        "persistentVolume1Type": "Standard_LRS",

        "masterLoadBalancerName": "[concat(variables('openshiftMasterHostname'), 'lb')]",
        "masterPublicIpAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('openshiftMasterPublicIpDnsLabel'))]",
        "masterLbId": "[resourceId('Microsoft.Network/loadBalancers', variables('masterLoadBalancerName'))]",
        "masterLbFrontEndConfigId": "[concat(variables('masterLbId'), '/frontendIPConfigurations/loadBalancerFrontEnd')]",
        "masterLbBackendPoolId": "[concat(variables('masterLbId'),'/backendAddressPools/loadBalancerBackend')]",
        "masterLbHttpProbeId": "[concat(variables('masterLbId'),'/probes/httpProbe')]",
        "masterLb8443ProbeId": "[concat(variables('masterLbId'),'/probes/8443Probe')]",
        "masterLbCockpitProbeId": "[concat(variables('masterLbId'),'/probes/cockpitProbe')]",

        "infraLoadBalancerName": "[concat(variables('openshiftInfraHostname'), 'lb')]",
        "infraPublicIpAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('infraLbPublicIpDnsLabel'))]",
        "infraLbId": "[resourceId('Microsoft.Network/loadBalancers', variables('infraLoadBalancerName'))]",
        "infraLbFrontEndConfigId": "[concat(variables('infraLbId'), '/frontendIPConfigurations/loadBalancerFrontEnd')]",
        "infraLbBackendPoolId": "[concat(variables('infraLbId'),'/backendAddressPools/loadBalancerBackend')]",
        "infraLbHttpProbeId": "[concat(variables('infraLbId'),'/probes/httpProbe')]",
        "infraLbHttpsProbeId": "[concat(variables('infraLbId'),'/probes/httpsProbe')]",
        "infraLbCockpitProbeId": "[concat(variables('infraLbId'),'/probes/cockpitProbe')]",
        "osType": {
            "publisher": "RedHat",
            "offer": "RHEL",
            "sku": "7-RAW",
            "version": "latest"
        },
        "redHatTags": {
            "app": "OpenShift",
            "provider": "9d2c71fc-96ba-4b4a-93b3-14def5bc96fc"
        },
        "bastionVmSize": "Standard_DS2_v2",
        "imageReference": "[variables('osType')]",
        "singlequote": "'",

        "sshKeyPath": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
        "bastionPrepScriptUrl": "[concat(parameters('_artifactsLocation'), '/scripts/bastionPrep.sh')]",
        "nodePrepScriptUrl": "[concat(parameters('_artifactsLocation'), '/scripts/nodePrep.sh')]",
        "masterPrepScriptUrl": "[concat(parameters('_artifactsLocation'), '/scripts/masterPrep.sh')]",
        "bastionPrepScriptFileName": "bastionPrep.sh",
        "nodePrepScriptFileName": "nodePrep.sh",
        "masterPrepScriptFileName": "masterPrep.sh",
        "clusterNodeDeploymentTemplateUrl": "[concat(parameters('_artifactsLocation'), '/nested/gallery', 'clusternode.json')]",
        "basicDeploymentTemplateUrl": "[concat(parameters('_artifactsLocation'), '/nested/gallery', 'basic.json')]",
        "openshiftDeploymentTemplateUrl": "[concat(parameters('_artifactsLocation'), '/nested/openshiftdeploy.json')]",
        "vmSizesMap": {
            "Standard_DS11_v2": {
                "storageAccountType": "Premium_LRS",
                "storageAccountTier": "Premium"
            },"Standard_DS2_v2": {
                "storageAccountType": "Premium_LRS",
                "storageAccountTier": "Premium"
            },
            "Standard_D2_v2": {
                "storageAccountType": "Standard_LRS",
                "storageAccountTier": "Standard"
            }
        }
    },
    "resources": [{
            "apiVersion": "[variables('apiVersionNetwork')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[concat(variables('openshiftBastionHostname'), '-nsg')]",
            "location": "[variables('location')]",
            "tags": {
                "displayName": "BastionNSG",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {
                "securityRules": [{
                    "name": "allowSSHin_all",
                    "properties": {
                        "description": "Allow SSH in from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "22",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 100,
                        "direction": "Inbound"
                    }
                }]
            }
        }, {
            "apiVersion": "[variables('apiVersionNetwork')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[concat(variables('openshiftMasterHostname'), '-nsg')]",
            "location": "[variables('location')]",
            "tags": {
                "displayName": "MasterNSG",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {
                "securityRules": [{
                    "name": "allowSSHin_all",
                    "properties": {
                        "description": "Allow SSH in from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "22",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 100,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowHTTPS_all",
                    "properties": {
                        "description": "Allow HTTPS connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "443",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 200,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowOpenShiftConsoleIn_all",
                    "properties": {
                        "description": "Allow OpenShift Console connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "8443",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 300,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowCockpitIn_all",
                    "properties": {
                        "description": "Allow Cockpit connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "9090",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 400,
                        "direction": "Inbound"
                    }
                }]
            }
        }, {
            "apiVersion": "[variables('apiVersionNetwork')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[concat(variables('openshiftInfraHostname'), '-nsg')]",
            "location": "[variables('location')]",
            "tags": {
                "displayName": "InfraNSG",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {
                "securityRules": [{
                    "name": "allowSSHin_all",
                    "properties": {
                        "description": "Allow SSH in from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "22",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 100,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowHTTPSIn_all",
                    "properties": {
                        "description": "Allow HTTPS connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "443",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 200,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowHTTPIn_all",
                    "properties": {
                        "description": "Allow HTTP connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "80",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 300,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowCockpitIn_all",
                    "properties": {
                        "description": "Allow Cockpit connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "9090",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 400,
                        "direction": "Inbound"
                    }
                }]
            }
        }, {
            "apiVersion": "[variables('apiVersionNetwork')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[concat(variables('openshiftNodeHostname'), '-nsg')]",
            "location": "[variables('location')]",
            "tags": {
                "displayName": "NodeNSG",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {
                "securityRules": [{
                    "name": "allowSSHin_all",
                    "properties": {
                        "description": "Allow SSH in from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "22",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 100,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowHTTPS_all",
                    "properties": {
                        "description": "Allow HTTPS connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "443",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 200,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowHTTPIn_all",
                    "properties": {
                        "description": "Allow HTTP connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "80",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 300,
                        "direction": "Inbound"
                    }
                }, {
                    "name": "allowCockpitIn_all",
                    "properties": {
                        "description": "Allow Cockpit connections from all locations",
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "destinationPortRange": "9090",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "*",
                        "access": "Allow",
                        "priority": 400,
                        "direction": "Inbound"
                    }
                }]
            }
        }, {
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[variables('virtualNetworkName')]",
            "location": "[variables('location')]",
            "tags": {
                "displayName": "VirtualNetwork",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "apiVersion": "[variables('apiVersionNetwork')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('addressPrefix')]"
                    ]
                },
                "subnets": [{
                    "name": "[variables('masterSubnetName')]",
                    "properties": {
                        "addressPrefix": "[variables('masterSubnetPrefix')]"
                    }
                }, {
                    "name": "[variables('nodeSubnetName')]",
                    "properties": {
                        "addressPrefix": "[variables('nodeSubnetPrefix')]"
                    }
                }]
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('newStorageAccountBastion')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "BastionStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "Premium_LRS",
                "tier": "Premium"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('newStorageAccountMaster')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "MasterStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountType]",
                "tier": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountTier]"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('newStorageAccountInfra')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "InfraStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountType]",
                "tier": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountTier]"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('newStorageAccountNodeOs')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "NodeStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountType]",
                "tier": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountTier]"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('newStorageAccountNodeData')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "NodeStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountType]",
                "tier": "[variables('vmSizesMap')[variables('masterVmSize')].storageAccountTier]"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('diagStorageAccount1')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "DiagnosticsStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('diagStorageAccount2')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "DiagnosticsStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('newStorageAccountRegistry')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "RegistryStorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            }
        }, {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('newStorageAccountPersistentVolume1')]",
            "location": "[variables('location')]",
            "kind": "Storage",
            "apiVersion": "[variables('apiVersionStorage')]",
            "tags": {
                "displayName": "PersistentVolume1StorageAccount",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            }
        }, {
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('bastionPublicIp')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftBastionPublicIP",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "dnsSettings": {
                    "domainNameLabel": "[variables('bastionPublicIpDnsLabel')]"
                }
            }
        }, {
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('infraLbPublicIpDnsLabel')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftInfraLBPublicIP",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                    "domainNameLabel": "[variables('infraLbPublicIpDnsLabel')]"
                }
            }
        }, {
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('openshiftMasterPublicIpDnsLabel')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftMasterPublicIP",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                    "domainNameLabel": "[variables('openshiftMasterPublicIpDnsLabel')]"
                }
            }
        }, {
            "type": "Microsoft.Compute/availabilitySets",
            "name": "masteravailabilityset",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionCompute')]",
            "tags": {
                "displayName": "MasterAvailabilitySet",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {}
        }, {
            "type": "Microsoft.Compute/availabilitySets",
            "name": "infraavailabilityset",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionCompute')]",
            "tags": {
                "displayName": "InfraAvailabilitySet",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {}
        }, {
            "type": "Microsoft.Compute/availabilitySets",
            "name": "nodeavailabilityset",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionCompute')]",
            "tags": {
                "displayName": "NodeAvailabilitySet",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "properties": {}
        }, {
            "type": "Microsoft.Network/loadBalancers",
            "name": "[variables('masterLoadBalancerName')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftMasterLB",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('openshiftMasterPublicIpDnsLabel'))]"
            ],
            "properties": {
                "frontendIPConfigurations": [{
                    "name": "LoadBalancerFrontEnd",
                    "properties": {
                        "publicIPAddress": {
                            "id": "[variables('masterPublicIpAddressId')]"
                        }
                    }
                }],
                "backendAddressPools": [{
                    "name": "loadBalancerBackEnd"
                }],
                "loadBalancingRules": [{
                    "name": "OpenShiftAdminConsole",
                    "properties": {
                        "frontendIPConfiguration": {
                            "id": "[variables('masterLbFrontEndConfigId')]"
                        },
                        "backendAddressPool": {
                            "id": "[variables('masterLbBackendPoolId')]"
                        },
                        "protocol": "Tcp",
                        "loadDistribution": "SourceIP",
                        "idleTimeoutInMinutes": 30,
                        "frontendPort": 8443,
                        "backendPort": 8443,
                        "probe": {
                            "id": "[variables('masterLb8443ProbeId')]"
                        }
                    }
                }, {
                    "name": "CockpitConsole",
                    "properties": {
                        "frontendIPConfiguration": {
                            "id": "[variables('masterLbFrontEndConfigId')]"
                        },
                        "backendAddressPool": {
                            "id": "[variables('masterLbBackendPoolId')]"
                        },
                        "protocol": "Tcp",
                        "loadDistribution": "SourceIP",
                        "idleTimeoutInMinutes": 30,
                        "frontendPort": 9090,
                        "backendPort": 9090,
                        "probe": {
                            "id": "[variables('masterLbCockpitProbeId')]"
                        }
                    }
                }],
                "probes": [{
                    "name": "8443Probe",
                    "properties": {
                        "protocol": "Tcp",
                        "port": 8443,
                        "intervalInSeconds": 5,
                        "numberOfProbes": 2
                    }
                }, {
                    "name": "cockpitProbe",
                    "properties": {
                        "protocol": "Tcp",
                        "port": 9090,
                        "intervalInSeconds": 5,
                        "numberOfProbes": 2
                    }
                }]
            }
        },
        {
            "apiVersion": "[variables('apiVersionNetwork')]",
            "type": "Microsoft.Network/loadBalancers/inboundNatRules",
            "name": "[concat(variables('masterLoadBalancerName'), '/', 'SSH-', variables('openshiftMasterHostname'), copyIndex())]",
            "location": "[variables('location')]",
            "copy": {
                "name": "masterLbLoop",
                "count": "[variables('masterInstanceCount')]"
            },
            "dependsOn": [
                "[variables('masterLbId')]"
            ],
            "properties": {
                "frontendIPConfiguration": {
                    "id": "[variables('masterLbFrontEndConfigId')]"
                },
                "protocol": "tcp",
                "frontendPort": "[copyIndex(2200)]",
                "backendPort": 22,
                "enableFloatingIP": false
            }
        },
        {
            "type": "Microsoft.Network/loadBalancers",
            "name": "[variables('infraLoadBalancerName')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftInfraLB",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('infraLbPublicIpDnsLabel'))]"
            ],
            "properties": {
                "frontendIPConfigurations": [{
                    "name": "LoadBalancerFrontEnd",
                    "properties": {
                        "publicIPAddress": {
                            "id": "[variables('infraPublicIpAddressId')]"
                        }
                    }
                }],
                "backendAddressPools": [{
                    "name": "loadBalancerBackEnd"
                }],
                "loadBalancingRules": [{
                    "name": "OpenShiftRouterHTTP",
                    "properties": {
                        "frontendIPConfiguration": {
                            "id": "[variables('infraLbFrontEndConfigId')]"
                        },
                        "backendAddressPool": {
                            "id": "[variables('infraLbBackendPoolId')]"
                        },
                        "protocol": "Tcp",
                        "frontendPort": 80,
                        "backendPort": 80,
                        "probe": {
                            "id": "[variables('infraLbHttpProbeId')]"
                        }
                    }
                }, {
                    "name": "OpenShiftRouterHTTPS",
                    "properties": {
                        "frontendIPConfiguration": {
                            "id": "[variables('infraLbFrontEndConfigId')]"
                        },
                        "backendAddressPool": {
                            "id": "[variables('infraLbBackendPoolId')]"
                        },
                        "protocol": "Tcp",
                        "frontendPort": 443,
                        "backendPort": 443,
                        "probe": {
                            "id": "[variables('infraLbHttpsProbeId')]"
                        }
                    }
                }, {
                    "name": "CockpitConsole",
                    "properties": {
                        "frontendIPConfiguration": {
                            "id": "[variables('infraLbFrontEndConfigId')]"
                        },
                        "backendAddressPool": {
                            "id": "[variables('infraLbBackendPoolId')]"
                        },
                        "protocol": "Tcp",
                        "frontendPort": 9090,
                        "backendPort": 9090,
                        "probe": {
                            "id": "[variables('infraLbCockpitProbeId')]"
                        }
                    }
                }],
                "probes": [{
                    "name": "httpProbe",
                    "properties": {
                        "protocol": "Tcp",
                        "port": 80,
                        "intervalInSeconds": 5,
                        "numberOfProbes": 2
                    }
                }, {
                    "name": "httpsProbe",
                    "properties": {
                        "protocol": "Tcp",
                        "port": 443,
                        "intervalInSeconds": 5,
                        "numberOfProbes": 2
                    }
                }, {
                    "name": "cockpitProbe",
                    "properties": {
                        "protocol": "Tcp",
                        "port": 9090,
                        "intervalInSeconds": 5,
                        "numberOfProbes": 2
                    }
                }]
            }
        }, {
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[concat(variables('openshiftBastionHostname'), '-nic')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftBastionNetworkInterface",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('openshiftBastionHostname'), '-nsg')]"
            ],
            "properties": {
                "ipConfigurations": [{
                    "name": "[concat(variables('openshiftBastionHostname'), 'ipconfig')]",
                    "properties": {
                        "privateIPAllocationMethod": "Dynamic",
                        "publicIPAddress": {
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/publicIPAddresses/', variables('bastionPublicIp'))]"
                        },
                        "subnet": {
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('masterSubnetName'))]"
                        }
                    }
                }],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', concat(variables('openshiftBastionHostname'), '-nsg'))]"
                }
            }
        }, {
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[concat(variables('openshiftMasterHostname'), '-', copyIndex(), '-nic')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftMasterNetworkInterface",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/loadBalancers/', variables('masterLoadBalancerName'))]",
                "[concat(variables('masterLbId'), '/inboundNatRules/SSH-', variables('openshiftMasterHostname') ,copyIndex())]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('openshiftMasterHostname'), '-nsg')]"
            ],
            "copy": {
                "name": "masterNicLoop",
                "count": "[variables('masterInstanceCount')]"
            },
            "properties": {
                "ipConfigurations": [{
                    "name": "[concat(variables('openshiftMasterHostname'), copyIndex(), 'ipconfig')]",
                    "properties": {
                        "privateIPAllocationMethod": "Dynamic",
                        "subnet": {
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('masterSubnetName'))]"
                        },
                        "loadBalancerBackendAddressPools": [{
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/loadBalancers/', variables('masterLoadBalancerName'), '/backendAddressPools/loadBalancerBackEnd')]"
                        }],
                        "loadBalancerInboundNatRules": [{
                            "id": "[concat(variables('masterLbId'),'/inboundNatRules/SSH-', variables('openshiftMasterHostname'), copyIndex())]"
                        }]
                    }
                }],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', concat(variables('openshiftMasterHostname'), '-nsg'))]"
                }
            }
        }, {
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[concat(variables('openshiftInfraHostname'), '-', copyIndex(), '-nic')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftInfraNetworkInterfaces",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/loadBalancers/', variables('infraLoadBalancerName'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('openshiftInfraHostname'), '-nsg')]"
            ],
            "copy": {
                "name": "infraNicLoop",
                "count": "[variables('infraInstanceCount')]"
            },
            "properties": {
                "ipConfigurations": [{
                    "name": "[concat(variables('openshiftInfraHostname'), copyIndex(), 'ipconfig')]",
                    "properties": {
                        "privateIPAllocationMethod": "Dynamic",
                        "subnet": {
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('masterSubnetName'))]"
                        },
                        "loadBalancerBackendAddressPools": [{
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/loadBalancers/', variables('infraLoadBalancerName'), '/backendAddressPools/loadBalancerBackEnd')]"
                        }]
                    }
                }],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', concat(variables('openshiftInfraHostname'), '-nsg'))]"
                }
            }
        }, {
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[concat(variables('openshiftNodeHostname'), '-', copyIndex(), '-nic')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionNetwork')]",
            "tags": {
                "displayName": "OpenShiftNodeNetworkInterfaces",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('openshiftNodeHostname'), '-nsg')]"
            ],
            "copy": {
                "name": "nodeNicLoop",
                "count": "[variables('nodeInstanceCount')]"
            },
            "properties": {
                "ipConfigurations": [{
                    "name": "[concat(variables('openshiftNodeHostname'), copyIndex(), 'ipconfig')]",
                    "properties": {
                        "privateIPAllocationMethod": "Dynamic",
                        "subnet": {
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('nodeSubnetName'))]"
                        }
                    }
                }],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', concat(variables('openshiftNodeHostname'), '-nsg'))]"
                }
            }
        }, {
            "name": "bastionVmDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersionLinkTemplate')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('newStorageAccountBastion'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagStorageAccount1'))]",
                "[concat('Microsoft.Network/networkInterfaces/', variables('openshiftBastionHostname'), '-nic')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('basicDeploymentTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "sshKeyPath": {
                        "value": "[variables('sshKeyPath')]"
                    },
                    "sshPublicKey": {
                        "value": "[parameters('sshPublicKey')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "vmSize": {
                        "value": "[variables('masterVmSize')]"
                    },
                    "hostname": {
                        "value": "[variables('openshiftBastionHostname')]"
                    },
                    "role": {
                        "value": "bastionnode"
                    },

                    "newStorageAccount": {
                        "value": "[variables('newStorageAccountBastion')]"
                    },
                    "diagStorageAccount": {
                        "value": "[variables('diagStorageAccount1')]"
                    },
                    "apiVersionStorage": {
                        "value": "[variables('apiVersionStorage')]"
                    },
                    "apiVersionCompute": {
                        "value": "[variables('apiVersionCompute')]"
                    }
                }
            }
        }, {
            "name": "[concat('masterVmDeployment', copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersionLinkTemplate')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('newStorageAccountMaster'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagStorageAccount1'))]",
                "masterNicLoop",
                "masteravailabilityset"
            ],
            "copy": {
                "name": "masterVmLoop",
                "count": "[variables('masterInstanceCount')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('clusterNodeDeploymentTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "sshKeyPath": {
                        "value": "[variables('sshKeyPath')]"
                    },
                    "sshPublicKey": {
                        "value": "[parameters('sshPublicKey')]"
                    },
                    "dataDiskSize": {
                        "value": "[variables('dataDiskSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "vmSize": {
                        "value": "[variables('masterVmSize')]"
                    },
                    "availabilitySet": {
                        "value": "masteravailabilityset"
                    },
                    "hostname": {
                        "value": "[concat(variables('openshiftMasterHostname'), '-', copyIndex())]"
                    },
                    "role": {
                        "value": "masternode"
                    },
                    "newStorageAccountOs": {
                        "value": "[variables('newStorageAccountMaster')]"
                    },
                    "newStorageAccountData": {
                        "value": "[variables('newStorageAccountMaster')]"
                    },
                    "diagStorageAccount": {
                        "value": "[variables('diagStorageAccount1')]"
                    },

                    "apiVersionStorage": {
                        "value": "[variables('apiVersionStorage')]"
                    },
                    "apiVersionCompute": {
                        "value": "[variables('apiVersionCompute')]"
                    }
                }
            }
        }, {
            "name": "[concat('infraVmDeployment', copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersionLinkTemplate')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('newStorageAccountInfra'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagStorageAccount1'))]",
                "infraNicLoop",
                "infraavailabilityset"
            ],
            "copy": {
                "name": "infraVmLoop",
                "count": "[variables('infraInstanceCount')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('clusterNodeDeploymentTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "sshKeyPath": {
                        "value": "[variables('sshKeyPath')]"
                    },
                    "sshPublicKey": {
                        "value": "[parameters('sshPublicKey')]"
                    },
                    "dataDiskSize": {
                        "value": "[variables('dataDiskSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "vmSize": {
                        "value": "[variables('infraVmSize')]"
                    },
                    "availabilitySet": {
                        "value": "infraavailabilityset"
                    },
                    "hostname": {
                        "value": "[concat(variables('openshiftInfraHostname'), '-', copyIndex())]"
                    },
                    "role": {
                        "value": "infranode"
                    },

                    "newStorageAccountOs": {
                        "value": "[variables('newStorageAccountInfra')]"
                    },
                    "newStorageAccountData": {
                        "value": "[variables('newStorageAccountInfra')]"
                    },
                    "diagStorageAccount": {
                        "value": "[variables('diagStorageAccount1')]"
                    },

                    "apiVersionStorage": {
                        "value": "[variables('apiVersionStorage')]"
                    },
                    "apiVersionCompute": {
                        "value": "[variables('apiVersionCompute')]"
                    }
                }
            }
        }, {
            "name": "[concat('nodeVmDeployment', copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersionLinkTemplate')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('newStorageAccountNodeOs'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('newStorageAccountNodeData'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagStorageAccount2'))]",
                "nodeNicLoop",
                "nodeavailabilityset"
            ],
            "copy": {
                "name": "nodeVmLoop",
                "count": "[variables('nodeInstanceCount')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('clusterNodeDeploymentTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "sshKeyPath": {
                        "value": "[variables('sshKeyPath')]"
                    },
                    "sshPublicKey": {
                        "value": "[parameters('sshPublicKey')]"
                    },
                    "dataDiskSize": {
                        "value": "[variables('dataDiskSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "vmSize": {
                        "value": "[variables('nodeVmSize')]"
                    },
                    "availabilitySet": {
                        "value": "nodeavailabilityset"
                    },
                    "hostname": {
                        "value": "[concat(variables('openshiftNodeHostname'), '-', copyIndex())]"
                    },
                    "role": {
                        "value": "appnode"
                    },

                    "newStorageAccountOs": {
                        "value": "[variables('newStorageAccountNodeOs')]"
                    },
                    "newStorageAccountData": {
                        "value": "[variables('newStorageAccountNodeData')]"
                    },
                    "diagStorageAccount": {
                        "value": "[variables('diagStorageAccount2')]"
                    },

                    "apiVersionStorage": {
                        "value": "[variables('apiVersionStorage')]"
                    },
                    "apiVersionCompute": {
                        "value": "[variables('apiVersionCompute')]"
                    }
                }
            }
        }, {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('openshiftBastionHostname'), '/deployOpenShift')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionCompute')]",
            "tags": {
                "displayName": "PrepBastion",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "bastionVmDeployment"
            ],
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[variables('bastionPrepScriptUrl')]"
                    ]
                },
                "protectedSettings": {
                    "commandToExecute": "[concat('bash ', variables('bastionPrepScriptFileName'), ' ', parameters('rhsmUsernamePasswordOrActivationKey'), ' ', parameters('rhsmUsernameOrOrgId'), ' ',variables('singlequote'), parameters('rhsmPasswordOrActivationKey'), variables('singlequote'), ' ', parameters('rhsmPoolId'))]"
                }
            }
        }, {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('openshiftMasterHostname'), '-', copyIndex(), '/prepMasters')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionCompute')]",
            "tags": {
                "displayName": "PrepMaster",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('masterVmDeployment', copyindex())]"
            ],
            "copy": {
                "name": "masterPrepLoop",
                "count": "[variables('masterInstanceCount')]"
            },
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[variables('masterPrepScriptUrl')]"
                    ]
                },
                "protectedSettings": {
                    "commandToExecute": "[concat('bash ', variables('masterPrepScriptFileName'), ' ', parameters('rhsmUsernamePasswordOrActivationKey'), ' ', parameters('rhsmUsernameOrOrgId'), ' ', variables('singlequote'), parameters('rhsmPasswordOrActivationKey'), variables('singlequote'), ' ', parameters('rhsmPoolId'), ' ', variables('newStorageAccountPersistentVolume1'), ' ', parameters('adminUsername'))]"
                }
            }
        }, {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('openshiftInfraHostname'), '-', copyIndex(), '/prepNodes')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionCompute')]",
            "tags": {
                "displayName": "PrepInfra",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('infraVmDeployment', copyindex())]"
            ],
            "copy": {
                "name": "infraPrepLoop",
                "count": "[variables('infraInstanceCount')]"
            },
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[variables('nodePrepScriptUrl')]"
                    ]
                },
                "protectedSettings": {
                    "commandToExecute": "[concat('bash ', variables('nodePrepScriptFileName'), ' ', parameters('rhsmUsernamePasswordOrActivationKey'), ' ', parameters('rhsmUsernameOrOrgId'), ' ', variables('singlequote'), parameters('rhsmPasswordOrActivationKey'), variables('singlequote'), ' ', parameters('rhsmPoolId'))]"
                }
            }
        }, {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('openshiftNodeHostname'), '-', copyIndex(), '/prepNodes')]",
            "location": "[variables('location')]",
            "apiVersion": "[variables('apiVersionCompute')]",
            "tags": {
                "displayName": "PrepNodes",
                "provider": "[variables('redHatTags').provider]",
                "app": "[variables('redHatTags').app]"
            },
            "dependsOn": [
                "[concat('nodeVmDeployment', copyindex())]"
            ],
            "copy": {
                "name": "nodePrepLoop",
                "count": "[variables('nodeInstanceCount')]"
            },
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[variables('nodePrepScriptUrl')]"
                    ]
                },
                "protectedSettings": {
                    "commandToExecute": "[concat('bash ', variables('nodePrepScriptFileName'), ' ', parameters('rhsmUsernamePasswordOrActivationKey'), ' ', parameters('rhsmUsernameOrOrgId'), ' ', variables('singlequote'), parameters('rhsmPasswordOrActivationKey'), variables('singlequote'), ' ', parameters('rhsmPoolId'))]"
                }
            }
        }, {
            "name": "OpenShiftDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersionLinkTemplate')]",
            "dependsOn": [
                "masterPrepLoop",
                "infraPrepLoop",
                "nodePrepLoop"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('openshiftDeploymentTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "apiVersionCompute": {
                        "value": "[variables('apiVersionCompute')]"
                    },
                    "newStorageAccountRegistry": {
                        "value": "[variables('newStorageAccountRegistry')]"
                    },
                    "newStorageAccountKey": {
                        "value": "[listKeys(variables('newStorageAccountRegistry'),'2015-06-15').key1]"
                    },
                    "newStorageAccountPersistentVolume1": {
                        "value": "[variables('newStorageAccountPersistentVolume1')]"
                    },
                    "newStorageAccountPV1Key": {
                        "value": "[listKeys(variables('newStorageAccountPersistentVolume1'),'2015-06-15').key1]"
                    },
                    "openshiftBastionHostname": {
                        "value": "[variables('openshiftBastionHostname')]"
                    },
                    "openshiftMasterHostname": {
                        "value": "[variables('openshiftMasterHostname')]"
                    },
                    "openshiftMasterPublicIpFqdn": {
                        "value": "[reference(variables('openshiftMasterPublicIpDnsLabel')).dnsSettings.fqdn]"
                    },
                    "openshiftMasterPublicIpAddress": {
                        "value": "[reference(variables('openshiftMasterPublicIpDnsLabel')).ipAddress]"
                    },
                    "openshiftInfraHostname": {
                        "value": "[variables('openshiftInfraHostname')]"
                    },
                    "openshiftNodeHostname": {
                        "value": "[variables('openshiftNodeHostname')]"
                    },
                    "masterInstanceCount": {
                        "value": "[variables('masterInstanceCount')]"
                    },
                    "infraInstanceCount": {
                        "value": "[variables('infraInstanceCount')]"
                    },
                    "nodeInstanceCount": {
                        "value": "[variables('nodeInstanceCount')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "openshiftPassword": {
                        "value": "[parameters('openshiftPassword')]"
                    },
                    "enableMetrics": {
                        "value": "[variables('enableMetrics')]"
                    },
                    "enableLogging": {
                        "value": "[variables('enableLogging')]"
                    },
                    "enableCockpit": {
                        "value": "[variables('enableCockpit')]"
                    },
                    "enableAzure": {
                        "value": "[variables('enableAzure')]"
                    },
                    "aadAppName": {
                        "value": "[parameters('aadAuthAppName')]"
                    },
                    "aadClientId": {
                        "value": "[variables('aadClientId')]"
                    },
                    "aadClientSecret": {
                        "value": "[variables('aadClientSecret')]"
                    },
                    "aadAuthClientId": {
                        "value": "[parameters('aadAuthClientId')]"
                    },
                    "aadAuthClientSecret": {
                        "value": "[parameters('aadAuthClientSecret')]"
                    },
                    "nipioDomain": {
                        "value": "[concat(reference(variables('infraLbPublicIpDnsLabel')).ipAddress, '.nip.io')]"
                    },
                    "customDomain": {
                        "value": "[variables('defaultSubDomain')]"
                    },
                    "subDomainChosen": {
                        "value": "[concat(variables('defaultSubDomainType'), 'Domain')]"
                    },
                    "sshPrivateKey": {
                        "reference": {
                            "keyvault": {
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.KeyVault/vaults/', parameters('keyVaultName'))]"
                            },
                            "secretName": "[parameters('keyVaultSecret')]"
                        }
                    }
                }
            }
        }
    ],
    "outputs": {
        "Openshift Console Url": {
            "type": "string",
            "value": "[concat('https://', reference(variables('openshiftMasterPublicIpDnsLabel')).dnsSettings.fqdn, ':8443/console')]"
        },
        "Bastion DNS FQDN": {
            "type": "string",
            "value": "[reference(variables('bastionPublicIp')).dnsSettings.fqdn]"
        },
        "Openshift Master SSH": {
            "type": "string",
            "value": "[concat('ssh ', parameters('adminUsername'), '@', reference(variables('openshiftMasterPublicIpDnsLabel')).dnsSettings.fqdn, ' -p 2200')]"
        },
        "Openshift Infra Load Balancer FQDN": {
            "type": "string",
            "value": "[reference(variables('infraLbPublicIpDnsLabel')).dnsSettings.fqdn]"
        },
        "Node OS Storage Account Name": {
            "type": "string",
            "value": "[variables('newStorageAccountNodeOs')]"
        },
        "Node Data Storage Account Name": {
            "type": "string",
            "value": "[variables('newStorageAccountNodeData')]"
        },
        "Infra Storage Account Name": {
            "type": "string",
            "value": "[variables('newStorageAccountInfra')]"
        }
    }
}
